<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...</title>
</head>
<body>
  <div id="status">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...</div>

  <script>
    const statusEl = document.getElementById("status");
    const params = new URLSearchParams(window.location.search);
    const currentUrl = params.get("current");

    if (!currentUrl) {
      const err = "‚ùå –û—à–∏–±–∫–∞: –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–∞ —Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è —Å—Å—ã–ª–∫–∏ (?current=...)";
      console.error(err);
      statusEl.textContent = err;
    } else {
      console.log("‚úÖ current =", currentUrl);
      checkLoop();
    }

    async function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function extractEntryValue(url) {
      try {
        const parsed = new URL(url);
        const val = parsed.searchParams.get("entry.1562754423");
        console.log(`üîç –ò–∑–≤–ª–µ—á–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ entry.1562754423: ${val}`);
        return val;
      } catch (e) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ entry.1562754423 –∏–∑ URL:", url, e);
        return null;
      }
    }

    async function getLatestHref() {
      try {
        const response = await fetch("latest.json", { cache: "no-store" });
        if (!response.ok) {
          console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ latest.json:", response.status);
          return null;
        }

        const data = await response.json();
        console.log("üì¶ –ó–∞–≥—Ä—É–∂–µ–Ω latest.json:", data);
        return data?.href || null;
      } catch (e) {
        console.error("‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ latest.json:", e);
        return null;
      }
    }

    async function checkLoop() {
      const currentValue = extractEntryValue(currentUrl);
      if (!currentValue) {
        const err = "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∑–Ω–∞—á–µ–Ω–∏–µ entry.1562754423 –∏–∑ —Ç–µ–∫—É—â–µ–π —Å—Å—ã–ª–∫–∏.";
        console.error(err);
        statusEl.textContent = err;
        return;
      }

      console.log("üöÄ –°—Ç–∞—Ä—Ç —Ü–∏–∫–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏...");

      // 1. –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
      let latest = await getLatestHref();
      let latestValue = extractEntryValue(latest);

      if (latestValue && latestValue !== currentValue) {
        console.log("‚úÖ –ù–∞–π–¥–µ–Ω–∞ –Ω–æ–≤–∞—è —Å—Å—ã–ª–∫–∞! –†–µ–¥–∏—Ä–µ–∫—Ç...");
        location.href = latest;
        return;
      }

      // 2. –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç
      for (let i = 10; i > 0; i--) {
        const text = `–û–∂–∏–¥–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ... –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ ${i} —Å–µ–∫.`;
        console.log(text);
        statusEl.textContent = text;
        await delay(1000);
      }

      // 3. –í—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
      latest = await getLatestHref();
      latestValue = extractEntryValue(latest);

      if (latestValue && latestValue !== currentValue) {
        console.log("‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –ø—Ä–∏ –≤—Ç–æ—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ! –†–µ–¥–∏—Ä–µ–∫—Ç...");
        location.href = latest;
        return;
      }

      // 4. –ü–∞—É–∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã
      console.log("‚åõ –ü–∞—É–∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ —Ç—Ä–µ—Ç—å–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π...");
      statusEl.textContent = "–§–∞–π–ª –≤—Å—ë –µ—â—ë –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω. –ü—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑...";
      await delay(2000);

      // 5. –¢—Ä–µ—Ç—å—è –ø—Ä–æ–≤–µ—Ä–∫–∞
      latest = await getLatestHref();
      latestValue = extractEntryValue(latest);

      if (latestValue && latestValue !== currentValue) {
        console.log("‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –ø—Ä–∏ —Ç—Ä–µ—Ç—å–µ–π –ø—Ä–æ–≤–µ—Ä–∫–µ! –†–µ–¥–∏—Ä–µ–∫—Ç...");
        location.href = latest;
      } else {
        const msg = "‚ùå –§–∞–π–ª –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
        console.warn(msg);
        statusEl.textContent = msg;
      }
    }
  </script>
</body>
</html>
