<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...</title>
</head>
<body>
  <div id="status">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...</div>

  <script>
    const statusEl = document.getElementById("status");

    // –ü–æ–ª—É—á–∞–µ–º "—Å—Ç–∞—Ä—É—é" —Å—Å—ã–ª–∫—É –∏–∑ URL, –Ω–∞–ø—Ä–∏–º–µ—Ä: redirect.html?current=result-old.html
    const params = new URLSearchParams(window.location.search);
    const current = params.get("current");

    if (!current) {
      statusEl.textContent = "–û—à–∏–±–∫–∞: –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û–∂–∏–¥–∞–π—Ç–µ –ø–∏—Å—å–º–æ —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –∞–Ω–∫–µ—Ç—É –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç–µ (?current=...)";
      throw new Error("Missing ?current= –ø–∞—Ä–∞–º–µ—Ç—Ä");
    }

    async function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function getLatestHref() {
      try {
        const response = await fetch("latest.json", { cache: "no-store" });
        if (!response.ok) return null;

        const data = await response.json();
        return data?.href || null;
      } catch (e) {
        return null;
      }
    }

    async function checkLoop() {
      // üîπ –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
      let latest = await getLatestHref();
      if (latest && latest !== current) {
        location.href = latest;
        return;
      }

      // üîπ –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç 10 —Å–µ–∫
      for (let i = 10; i > 0; i--) {
        statusEl.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö... –ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è —á–µ—Ä–µ–∑ ${i} —Å–µ–∫.`;
        await delay(1000);
      }

      // üîπ –í—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
      latest = await getLatestHref();
      if (latest && latest !== current) {
        location.href = latest;
        return;
      }

      // üîπ –ü–∞—É–∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã
      statusEl.textContent = "–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ü—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑...";
      await delay(2000);

      // üîπ –¢—Ä–µ—Ç—å—è –ø—Ä–æ–≤–µ—Ä–∫–∞
      latest = await getLatestHref();
      if (latest && latest !== current) {
        location.href = latest;
      } else {
        statusEl.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –û–∂–∏–¥–∞–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∞–Ω–∫–µ—Ç—É –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç–µ.";
      }
    }

    checkLoop();
  </script>
</body>
</html>
