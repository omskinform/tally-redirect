<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }
    #countdown {
      font-size: 2em;
      margin-top: 10px;
    }
    button {
      margin-top: 20px;
      padding: 0.5em 1em;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <div>
    <div id="status">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...</div>
    <div id="countdown"></div>
    <button id="retry" style="display:none;" onclick="location.reload()">üîÅ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>
  </div>

  <script>
    const JSON_URL = "https://omskinform.github.io/tally-redirect/latest.json";
    let attempts = 0;

    async function fetchLink() {
      const timestamp = Date.now();
      const response = await fetch(`${JSON_URL}?t=${timestamp}`, { cache: "reload" });
      if (!response.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å JSON");
      const json = await response.json();
      if (!json.href) throw new Error("–°—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ JSON");
      console.log("–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞:", json.href);
      return json.href;
    }

    function startCountdown(seconds) {
      return new Promise(resolve => {
        const countdown = document.getElementById("countdown");
        const status = document.getElementById("status");
        status.textContent = "‚è≥ –ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è —á–µ—Ä–µ–∑...";
        countdown.textContent = seconds;
        const interval = setInterval(() => {
          seconds--;
          if (seconds <= 0) {
            clearInterval(interval);
            countdown.textContent = "";
            resolve();
          } else {
            countdown.textContent = seconds;
          }
        }, 1000);
      });
    }

    async function attemptCycle() {
      const status = document.getElementById("status");

      try {
        // –®–∞–≥ 1: –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        status.textContent = "‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...";
        const href1 = await fetchLink();

        // –®–∞–≥ 2: –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç 25 —Å–µ–∫—É–Ω–¥
        await startCountdown(25);

        // –®–∞–≥ 3: –í—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        const href2 = await fetchLink();
        if (href2 !== href1) {
          location.href = href2;
          return;
        }

        // –®–∞–≥ 4: reload #1 –ø–æ—Å–ª–µ 5 —Å–µ–∫—É–Ω–¥, —Å—Ç–∞—Ç—É—Å "–û—Ç–∫—Ä—ã–≤–∞–µ–º –∞–Ω–∫–µ—Ç—É..."
        status.textContent = "‚è≥ –û—Ç–∫—Ä—ã–≤–∞–µ–º –∞–Ω–∫–µ—Ç—É...";
        await new Promise(r => setTimeout(r, 5000));
        const href3 = await fetchLink();
        if (href3 !== href1) {
          location.href = href3;
          return;
        }

        // –®–∞–≥ 5: reload #2 –ø–æ—Å–ª–µ 5 —Å–µ–∫—É–Ω–¥, —Å—Ç–∞—Ç—É—Å "‚è≥ –ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ..."
        status.textContent = "‚è≥ –ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ...";
        await new Promise(r => setTimeout(r, 5000));
        const href4 = await fetchLink();
        if (href4 !== href1) {
          location.href = href4;
          return;
        }

        // –®–∞–≥ 6: –ü–æ–≤—Ç–æ—Ä —Ü–∏–∫–ª–∞ (—Ä–∞–∑—Ä–µ—à—ë–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
        attempts++;
        if (attempts < 2) {
          console.warn("–¶–∏–∫–ª –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –ø–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–ø—ã—Ç–∫—É...");
          await attemptCycle(); // –ø–æ–≤—Ç–æ—Ä —Ü–∏–∫–ª–∞
        } else {
          status.textContent = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
          document.getElementById("retry").style.display = "inline-block";
        }

      } catch (err) {
        status.textContent = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Å—ã–ª–∫–∏: " + err.message;
        document.getElementById("retry").style.display = "inline-block";
      }
    }

    // –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
    setTimeout(attemptCycle, 1000);
  </script>
</body>
</html>
