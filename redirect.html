<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
      padding: 1em;
    }
    #countdown {
      font-size: 2em;
      margin-top: 10px;
    }
    button {
      margin-top: 20px;
      padding: 0.5em 1em;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <div>
    <div id="status">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...</div>
    <div id="countdown"></div>
    <button id="retry" style="display:none;" onclick="location.reload()">üîÅ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>
  </div>

  <script>
    const JSON_URL = "https://omskinform.github.io/tally-redirect/latest.json";

    async function fetchLink() {
      const timestamp = Date.now();
      const response = await fetch(`${JSON_URL}?t=${timestamp}`, { cache: "no-store" });
      if (!response.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å JSON");
      const json = await response.json();
      if (!json.href) throw new Error("–°—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ JSON");
      return json.href;
    }

    function startCountdown(seconds, label = "‚è≥ –ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –Ω–∞—á–Ω—ë—Ç—Å—è —á–µ—Ä–µ–∑") {
      return new Promise(resolve => {
        const countdown = document.getElementById("countdown");
        countdown.textContent = `${label}: ${seconds}`;
        const interval = setInterval(() => {
          seconds--;
          if (seconds <= 0) {
            clearInterval(interval);
            countdown.textContent = "";
            resolve();
          } else {
            countdown.textContent = `${label}: ${seconds}`;
          }
        }, 1000);
      });
    }

    async function attemptRedirect() {
      const status = document.getElementById("status");
      const retry = document.getElementById("retry");

      try {
        // –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ (–±–µ–∑ –æ—Ç—Å—á–µ—Ç–∞)
        const href1 = await fetchLink();
        await new Promise(r => setTimeout(r, 3000));

        // –í—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ (–æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç 20 —Å–µ–∫)
        const href2 = await fetchLink();
        if (href2 !== href1) {
          location.href = href2;
          return;
        }

        status.textContent = "‚è≥ –ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –Ω–∞—á–Ω—ë—Ç—Å—è —á–µ—Ä–µ–∑...";
        await startCountdown(20);

        const href3 = await fetchLink();
        if (href3 !== href1) {
          location.href = href3;
          return;
        }

        // –¢—Ä–µ—Ç—å—è –ø–æ–ø—ã—Ç–∫–∞ (–ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø–∞—É–∑–æ–π)
        status.textContent = "‚è≥ –û—Ç–∫—Ä—ã–≤–∞–µ–º –∞–Ω–∫–µ—Ç—É...";
        await new Promise(r => setTimeout(r, 3000));

        const href4 = await fetchLink();
        if (href4 !== href1) {
          location.href = href4;
          return;
        }

        // –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ –¥–∞–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        status.textContent = "‚ùå –ê–Ω–∫–µ—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
        retry.style.display = "inline-block";

      } catch (err) {
        status.textContent = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Å—ã–ª–∫–∏: " + err.message;
        retry.style.display = "inline-block";
      }
    }

    attemptRedirect();
  </script>
</body>
</html>
