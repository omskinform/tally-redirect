<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }
    #countdown {
      font-size: 2em;
      margin-top: 10px;
    }
    button {
      margin-top: 20px;
      padding: 0.5em 1em;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <div>
    <div id="status">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ</div>
    <div id="countdown"></div>
    <button id="retry" style="display:none;" onclick="location.reload()">üîÅ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>
  </div>

  <script>
    const JSON_URL = "https://omskinform.github.io/tally-redirect/latest.json";

    async function fetchLink() {
      const timestamp = Date.now();
      const response = await fetch(`${JSON_URL}?t=${timestamp}`, { cache: "no-store" });
      if (!response.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å JSON");
      const json = await response.json();
      if (!json.href) throw new Error("–°—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ JSON");
      return json.href;
    }

    function startCountdown(seconds, label = "‚è≥ –ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –Ω–∞—á–Ω—ë—Ç—Å—è —á–µ—Ä–µ–∑") {
      return new Promise(resolve => {
        const countdown = document.getElementById("countdown");
        countdown.textContent = `${label}: ${seconds}`;
        const interval = setInterval(() => {
          seconds--;
          if (seconds <= 0) {
            clearInterval(interval);
            countdown.textContent = "";
            resolve();
          } else {
            countdown.textContent = `${label}: ${seconds}`;
          }
        }, 1000);
      });
    }

    async function attemptRedirect() {
      const status = document.getElementById("status");
      const retry = document.getElementById("retry");

      try {
        // 1-—è –ø–æ–ø—ã—Ç–∫–∞ (–¥–≤–æ–π–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å –ø–∞—É–∑–æ–π)
        status.textContent = "‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ";
        const href1 = await fetchLink();
        await new Promise(r => setTimeout(r, 500));
        const href1b = await fetchLink();

        if (href1b !== href1) {
          location.href = href1b;
          return;
        }

        // 2-—è –ø–æ–ø—ã—Ç–∫–∞
        await new Promise(r => setTimeout(r, 5000));
        const href2 = await fetchLink();
        if (href2 !== href1) {
          location.href = href2;
          return;
        }

        // –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç –ø–µ—Ä–µ–¥ 3-–π –ø–æ–ø—ã—Ç–∫–æ–π
        await startCountdown(25);

        const href3 = await fetchLink();
        if (href3 !== href1) {
          location.href = href3;
          return;
        }

        // –§–∏–Ω–∞–ª ‚Äî –Ω–µ —É–¥–∞–ª–æ—Å—å
        status.textContent = "‚ùå –ê–Ω–∫–µ—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
        retry.style.display = "inline-block";

      } catch (err) {
        status.textContent = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Å—ã–ª–∫–∏: " + err.message;
        retry.style.display = "inline-block";
      }
    }

    // –î–∞—ë–º —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ–≥—Ä—É–∑–∏—Ç—å—Å—è –∏ CDN ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
    setTimeout(() => {
      attemptRedirect();
    }, 2000);
  </script>
</body>
</html>
