<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }
    #countdown {
      font-size: 2em;
      margin-top: 10px;
    }
    button {
      margin-top: 20px;
      padding: 0.5em 1em;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <div>
    <div id="status">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ</div>
    <div id="countdown"></div>
    <button id="retry" style="display:none;" onclick="location.reload()">üîÅ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>
  </div>

  <script>
    const JSON_URL = "https://omskinform.github.io/tally-redirect/latest.json";

    async function fetchLink() {
      const timestamp = Date.now();
      const response = await fetch(`${JSON_URL}?t=${timestamp}`, { cache: "reload" });
      if (!response.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å JSON");
      const json = await response.json();
      if (!json.href) throw new Error("–°—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ JSON");
      console.log("–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞:", json.href);
      return json.href;
    }

    function startCountdown(seconds) {
      return new Promise(resolve => {
        const countdown = document.getElementById("countdown");
        const status = document.getElementById("status");
        status.textContent = "‚è≥ –ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –Ω–∞—á–Ω—ë—Ç—Å—è —á–µ—Ä–µ–∑...";
        countdown.textContent = seconds;
        const interval = setInterval(() => {
          seconds--;
          if (seconds <= 0) {
            clearInterval(interval);
            countdown.textContent = "";
            resolve();
          } else {
            countdown.textContent = seconds;
          }
        }, 1000);
      });
    }

    async function attemptRedirect() {
      const status = document.getElementById("status");

      try {
        const href1 = await fetchLink();
        await new Promise(r => setTimeout(r, 3000)); // 3 —Å–µ–∫ –æ–∂–∏–¥–∞–Ω–∏–µ

        const href2 = await fetchLink();
        if (href2 !== href1) {
          location.href = href2;
          return;
        }

        await startCountdown(20); // –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç

        const href3 = await fetchLink();
        if (href3 !== href1) {
          location.href = href3;
          return;
        }

        status.textContent = "‚è≥ –û—Ç–∫—Ä—ã–≤–∞–µ–º –∞–Ω–∫–µ—Ç—É...";
        await new Promise(r => setTimeout(r, 5000)); // —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø–∞—É–∑–∞

        const href4 = await fetchLink();
        if (href4 !== href1) {
          location.href = href4;
          return;
        }

        // üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º, –∫–∞–∫ –µ—Å–ª–∏ –±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –Ω–∞ –∫–Ω–æ–ø–∫—É
        console.warn("–°—Å—ã–ª–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏");
        location.reload();

      } catch (err) {
        document.getElementById("status").textContent = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Å—ã–ª–∫–∏: " + err.message;
        document.getElementById("retry").style.display = "inline-block";
      }
    }

    // –°—Ç–∞—Ä—Ç—É–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    setTimeout(attemptRedirect, 2000);
  </script>
</body>
</html>
