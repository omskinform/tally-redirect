<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Ожидание результата...</title>
</head>
<body>
  <div id="status">Проверка результата...</div>

  <script>
    const statusEl = document.getElementById("status");
    const params = new URLSearchParams(window.location.search);
    const currentUrl = params.get("current");

    if (!currentUrl) {
      statusEl.textContent = "Ошибка: не передана текущая версия ссылки (?current=...)";
    } else {
      checkLoop();
    }

    async function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function extractEntryValue(url) {
      try {
        const parsed = new URL(url);
        return parsed.searchParams.get("entry.1562754423");
      } catch (e) {
        return null;
      }
    }

    async function getLatestHref() {
      try {
        const response = await fetch("latest.json", { cache: "no-store" });
        if (!response.ok) return null;
        const data = await response.json();
        return data?.href || null;
      } catch (e) {
        return null;
      }
    }

    async function checkLoop() {
      const currentValue = extractEntryValue(currentUrl);
      if (!currentValue) {
        statusEl.textContent = "Ошибка: не удалось извлечь значение entry.1562754423 из текущей ссылки.";
        return;
      }

      // 1. Первая проверка
      let latest = await getLatestHref();
      let latestValue = extractEntryValue(latest);

      if (latestValue && latestValue !== currentValue) {
        location.href = latest;
        return;
      }

      // 2. Обратный отсчет
      for (let i = 10; i > 0; i--) {
        statusEl.textContent = `Ожидаем обновление... Повтор через ${i} сек.`;
        await delay(1000);
      }

      // 3. Вторая проверка
      latest = await getLatestHref();
      latestValue = extractEntryValue(latest);
      if (latestValue && latestValue !== currentValue) {
        location.href = latest;
        return;
      }

      // 4. Пауза 2 секунды
      statusEl.textContent = "Файл всё ещё не обновлён. Пробуем ещё раз...";
      await delay(2000);

      // 5. Третья проверка
      latest = await getLatestHref();
      latestValue = extractEntryValue(latest);
      if (latestValue && latestValue !== currentValue) {
        location.href = latest;
      } else {
        statusEl.textContent = "Файл не обновился. Попробуйте позже.";
      }
    }
  <
